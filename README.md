# 达妙电机驱动开源

## 序言 
此代码主要是对于J10010L-2EC和J4310-2EC,以及我踩过的坑进行说明。使用的是cubeMX+keil5开发,单片机是stm32F407IGH6(大疆C板)。在文件中dm-tools为达妙上位机(调试助手),motor_DM为代码,use_motorExplain为达妙电机的开发文档(达妙官方)。此代码是对达妙电机MIT模式进行开发,并没有采用寄存器的方法。此代码已经在两款不同电机一起运行测试过了。达妙是用标准帧传输。

## 注意
1. 如果电机是J10010L-2EC需要注意电机的can线如果开发过dji的电机会下意识以为直接插进去是对的,实际上can_L和can_H是反的(我手上两个电机生产日期在2024年8月份之前)都有这个问题,所以需要注意当代码检查是对的就是无法通信那应该是这个问题。
2. 如果电机是J4310-2EC V1.2版本需注意**电机上位机(调试助手)应选V2.1.5.3版本**及以上。
3. 达妙的电机说明文档并没有说明全部控制相关的代码需要到**达妙电机的开发文档**中才能了解到全部。
4. **达妙电机的返回数据和发送数据的最值取决于电机在调试助手中的设定数值。**
5. 在代码中我是采用J10010L-2EC canid为1,返回数据id为0(此数值可以在调试助手中修改),角度(-12.57~12.57)速度(-50~50)力(-100,100),J4310-2EC canid为2,返回数据id为0(此数值可以在调试助手中修改),角度(-12.57~12.57)速度(-30~30)力(-30,30)。

## 代码内容和来源
以下函数均在motor_DM中(在motor_DM.h中第7行motor_DM_N修改电机数量)

1. 关于fp32和uint16_t互转在代码的第21行和35行,此代码来源于达妙电机的开发文档中的调试助手使用说明书的第33页和第40页。然后就是对CAN发送的封装motor_DM_Handle_send函数。

2. 对于电机的使能、失能和零点设置
   motor_DM_enable函数(使能)和motor_DM_lose函数(失能),在达妙定义中用标准帧按照stdId为电机id+FF FF FF FF FF FF FF FC为使能,stdId为电机id+FF FF FF FF FF FF FF FD为失能。
   motor_DM_zero函数(零点设置),按照stdId为电机id+FF FF FF FF FF FF FF FE,代码会把电机先失能在使能。在达妙电机的开发文档中的调试助手使用说明书的第37页。

3. 对于电机发送和接收
   接收用的是CAN的HAL_CAN_RxFifo0MsgPendingCallback中断回调函数,然后在通过motor_DM_recv_data函数解析数值。发送通过motor_DM_send函数+motor_DM_send_handle函数(解析数据)。

代码的使用上电要使能才能运行电机。在电机使用需要创user_DM_send结构体(电机发送)通过motor_DM_send_init函数初始化传入地址和从const user_DM_recv结构体(电机接收)通过motor_DM_recv_return接收数据指针然后传入地址。

## 声明
    此代码为开源代码。
    此代码是通过达妙官方文档配置而来。
    此代码的can的配置默认使用大疆创新的代码。   
    如果用此代码造成电机损坏本人均不负责。


